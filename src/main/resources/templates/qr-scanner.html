<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner - LogSphere</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        .work-mode-selector {
            margin: 20px 0;
        }
    </style>
</head>
<body class="bg-dark text-light">
    <nav class="navbar navbar-dark bg-black p-3">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 text-warning">QR Code Attendance Scanner</span>
            <a href="/" class="btn btn-outline-warning btn-sm">Home</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card bg-black shadow-lg">
                    <div class="card-header bg-dark text-center">
                        <h4 class="text-warning mb-0">Scan Employee QR Code</h4>
                    </div>
                    <div class="card-body">
                        <!-- Work Mode Selector -->
                        <div class="work-mode-selector">
                            <label class="form-label text-warning"><strong>Select Work Mode:</strong></label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="workMode" id="office" value="OFFICE" checked>
                                <label class="btn btn-outline-warning" for="office">üè¢ Office</label>

                                <input type="radio" class="btn-check" name="workMode" id="wfh" value="WORK_FROM_HOME">
                                <label class="btn btn-outline-warning" for="wfh">üè† Work From Home</label>

                                <input type="radio" class="btn-check" name="workMode" id="onsite" value="ON_SITE">
                                <label class="btn btn-outline-warning" for="onsite">üöó On-Site</label>
                            </div>
                        </div>

                        <!-- QR Scanner -->
                        <div id="reader" class="mb-3"></div>

                        <!-- Action Buttons -->
                        <div class="text-center mb-3">
                            <button id="clockInBtn" class="btn btn-success btn-lg me-2" onclick="clockIn()">Clock In</button>
                            <button id="clockOutBtn" class="btn btn-danger btn-lg" onclick="clockOut()">Clock Out</button>
                        </div>

                        <!-- Status Messages -->
                        <div id="statusMessage" class="alert" style="display: none;"></div>

                        <!-- Scanned Employee Info -->
                        <div id="employeeInfo" class="card bg-dark mt-3" style="display: none;">
                            <div class="card-body">
                                <h5 class="text-warning">Scanned Employee:</h5>
                                <p id="employeeDetails" class="text-light"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let scannedQRData = null;
        let html5QrcodeScanner = null;

        // Initialize QR Scanner
        function onScanSuccess(decodedText, decodedResult) {
            scannedQRData = decodedText;
            document.getElementById('statusMessage').style.display = 'block';
            document.getElementById('statusMessage').className = 'alert alert-info';
            document.getElementById('statusMessage').innerHTML = 'QR Code scanned successfully! Click Clock In or Clock Out.';
            
            // Parse and display employee info
            const parts = decodedText.split(':');
            if (parts.length === 3 && parts[0] === 'LOGSPHERE') {
                document.getElementById('employeeInfo').style.display = 'block';
                document.getElementById('employeeDetails').innerHTML = 
                    '<strong>Employee ID:</strong> ' + parts[1] + '<br>' +
                    '<strong>Token:</strong> ' + parts[2].substring(0, 8) + '...';
            }
        }

        function onScanFailure(error) {
            // Ignore scan failures
        }

        // Start scanner
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start(
            { facingMode: "environment" },
            {
                fps: 10,
                qrbox: { width: 250, height: 250 }
            },
            onScanSuccess,
            onScanFailure
        );

        function clockIn() {
            if (!scannedQRData) {
                alert('Please scan a QR code first!');
                return;
            }

            const workMode = document.querySelector('input[name="workMode"]:checked').value;
            const parts = scannedQRData.split(':');
            
            if (parts.length !== 3 || parts[0] !== 'LOGSPHERE') {
                alert('Invalid QR code format!');
                return;
            }

            const employeeId = parts[1];
            const token = parts[2];

            fetch('/attendance/qr/clockin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `employeeId=${employeeId}&token=${token}&workMode=${workMode}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('statusMessage').className = 'alert alert-success';
                    document.getElementById('statusMessage').innerHTML = 
                        '‚úì Clocked in successfully!<br>Work Mode: ' + data.workMode + '<br>Time: ' + data.time;
                } else {
                    document.getElementById('statusMessage').className = 'alert alert-danger';
                    document.getElementById('statusMessage').innerHTML = '‚úó Error: ' + data.message;
                }
            })
            .catch(error => {
                document.getElementById('statusMessage').className = 'alert alert-danger';
                document.getElementById('statusMessage').innerHTML = '‚úó Error: ' + error.message;
            });
        }

        function clockOut() {
            if (!scannedQRData) {
                alert('Please scan a QR code first!');
                return;
            }

            const parts = scannedQRData.split(':');
            
            if (parts.length !== 3 || parts[0] !== 'LOGSPHERE') {
                alert('Invalid QR code format!');
                return;
            }

            const employeeId = parts[1];
            const token = parts[2];

            fetch('/attendance/qr/clockout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `employeeId=${employeeId}&token=${token}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('statusMessage').className = 'alert alert-success';
                    document.getElementById('statusMessage').innerHTML = 
                        '‚úì Clocked out successfully!<br>Time: ' + data.time;
                } else {
                    document.getElementById('statusMessage').className = 'alert alert-danger';
                    document.getElementById('statusMessage').innerHTML = '‚úó Error: ' + data.message;
                }
            })
            .catch(error => {
                document.getElementById('statusMessage').className = 'alert alert-danger';
                document.getElementById('statusMessage').innerHTML = '‚úó Error: ' + error.message;
            });
        }

        // Stop scanner when page unloads
        window.addEventListener('beforeunload', () => {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop();
            }
        });
    </script>
</body>
</html>
