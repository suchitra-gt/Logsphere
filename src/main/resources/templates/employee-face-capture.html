<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Registration - LogSphere</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        #video {
            border: 3px solid #ffc107;
            border-radius: 10px;
        }
        .capture-area {
            background: #000;
            border-radius: 10px;
            padding: 20px;
        }
    </style>
</head>
<body class="bg-dark text-light">
    <nav class="navbar navbar-dark bg-black p-3">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 text-warning">LogSphere</span>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card bg-black shadow-lg">
                    <div class="card-header bg-dark text-center">
                        <h3 class="text-warning mb-0">ðŸ“· Face Registration</h3>
                        <p class="text-secondary mb-0 mt-2">Please register your face for attendance</p>
                    </div>
                    <div class="card-body">
                        <div class="capture-area text-center mb-4">
                            <video id="video" width="100%" height="400" autoplay style="display:none;"></video>
                            <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
                            <div id="preview" class="mb-3"></div>
                            <div id="instructions" class="text-info">
                                <p>Click "Start Camera" to begin face registration</p>
                                <p class="small">Make sure you have good lighting and face the camera directly</p>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-warning btn-lg" onclick="startCamera()" id="startBtn">
                                ðŸ“· Start Camera
                            </button>
                            <button type="button" class="btn btn-success btn-lg" onclick="captureFace()" id="captureBtn" style="display:none;">
                                ðŸ“¸ Capture Face
                            </button>
                            <button type="button" class="btn btn-danger" onclick="stopCamera()" id="stopBtn" style="display:none;">
                                Stop Camera
                            </button>
                            <form id="faceForm" th:action="@{/employee/register-face}" method="post" style="display:none;">
                                <input type="hidden" id="faceImage" name="faceImage">
                                <button type="submit" class="btn btn-success btn-lg w-100">âœ… Register Face</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let stream = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('preview');
        const faceImageInput = document.getElementById('faceImage');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const stopBtn = document.getElementById('stopBtn');
        const faceForm = document.getElementById('faceForm');
        const instructions = document.getElementById('instructions');

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'user' 
                    } 
                });
                video.srcObject = stream;
                video.style.display = 'block';
                startBtn.style.display = 'none';
                captureBtn.style.display = 'block';
                stopBtn.style.display = 'block';
                instructions.style.display = 'none';
            } catch (err) {
                alert('Error accessing camera: ' + err.message);
                console.error('Camera error:', err);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.style.display = 'none';
                startBtn.style.display = 'block';
                captureBtn.style.display = 'none';
                stopBtn.style.display = 'none';
                instructions.style.display = 'block';
                preview.innerHTML = '';
                faceForm.style.display = 'none';
            }
        }

        function captureFace() {
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, 640, 480);
            const imageData = canvas.toDataURL('image/jpeg', 0.9);
            
            // Store base64 image
            faceImageInput.value = imageData;
            
            // Show preview
            preview.innerHTML = '<img src="' + imageData + '" class="img-thumbnail" style="max-width: 100%; border: 3px solid #28a745;">';
            
            // Show register button
            faceForm.style.display = 'block';
            
            // Stop camera
            stopCamera();
        }
    </script>
</body>
</html>

